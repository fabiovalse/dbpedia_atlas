// Generated by CoffeeScript 1.4.0
(function() {
  var C, CELL_RADIUS, GRID_HEIGHT, GRID_WIDTH, M, REGION_LABEL_MIN_AREA, SIMPLIFICATION, SIZE, UNTYPED_DX, UNTYPED_DY, cities_layer, cos30, cursor, cursor_layer, data_props_density_color, defs, depth_color, dx, dy, inset_color, land_layer, leaf_labels_layer, map_layer, obj_props_density_color, path_generator, region_labels_layer, relations_layer, sea_layer, sin30, svg, triple_density_color, untyped_land_layer, untyped_layer, vis, zoom_layer, _draw_leaf_labels, _get_hexagon, _hex_path, _ij_to_xy, _init_modes, _move_cursor, _on_hex_click, _preprocess, _preprocess_selection, _update_lod;

  window.map = {};

  /* globals
  */


  svg = null;

  defs = null;

  zoom_layer = null;

  vis = null;

  map_layer = null;

  cursor = null;

  sea_layer = null;

  untyped_layer = null;

  untyped_land_layer = null;

  land_layer = null;

  leaf_labels_layer = null;

  cities_layer = null;

  relations_layer = null;

  region_labels_layer = null;

  cursor_layer = null;

  SIZE = 100;

  CELL_RADIUS = 0.02;

  sin30 = Math.sin(Math.PI / 6);

  cos30 = Math.cos(Math.PI / 6);

  UNTYPED_DX = -6;

  UNTYPED_DY = 0;

  map.init = function(dom_node) {
    var bcr, bluerect, placemark, sea_pattern, u_px_ratio;
    svg = d3.select(dom_node);
    map.node = svg;
    svg.attr({
      viewBox: "" + (-SIZE / 2) + " " + (-SIZE / 2) + " " + SIZE + " " + SIZE
    });
    defs = svg.append('defs');
    /* define sea pattern
    */

    sea_pattern = defs.append('pattern').attr({
      id: 'sea_pattern',
      x: 0,
      y: 0,
      width: 30,
      height: 30,
      patternUnits: 'userSpaceOnUse'
    });
    sea_pattern.append('path').attr({
      d: 'M0 0.5 L 10 0.5',
      stroke: 'rgba(30,0,0,0.4)',
      'stroke-width': '0.3'
    });
    sea_pattern.append('path').attr({
      d: 'M15 15.5 L 25 15.5',
      stroke: 'rgba(30,0,0,0.4)',
      'stroke-width': '0.3'
    });
    /* init test
    */

    svg.append('rect').attr({
      "class": 'debug',
      x: -SIZE / 2,
      y: -SIZE / 2,
      width: SIZE,
      height: SIZE,
      stroke: 'red'
    });
    bcr = svg.node().getBoundingClientRect();
    u_px_ratio = SIZE / Math.min(bcr.width, bcr.height);
    bluerect = svg.append('rect').attr({
      "class": 'debug',
      x: -bcr.width / 2 * u_px_ratio,
      y: -bcr.height / 2 * u_px_ratio,
      width: bcr.width * u_px_ratio,
      height: bcr.height * u_px_ratio,
      stroke: 'blue'
    });
    d3.select(window).on('resize', function() {
      bcr = svg.node().getBoundingClientRect();
      u_px_ratio = SIZE / Math.min(bcr.width, bcr.height);
      return bluerect.attr({
        x: -bcr.width / 2 * u_px_ratio,
        y: -bcr.height / 2 * u_px_ratio,
        width: bcr.width * u_px_ratio,
        height: bcr.height * u_px_ratio,
        stroke: 'green'
      });
    });
    /* END init test
    */

    /* ZOOM and PAN
    */

    zoom_layer = svg.append('g');
    svg.call(d3.behavior.zoom().scaleExtent([0.6, 600]).on('zoom', function() {
      zoom_layer.attr({
        transform: "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")"
      });
      /* semantic zooming
      */

      zoom_layer.selectAll('.label').attr({
        transform: "scale(" + (1 / d3.event.scale) + ") rotate(60)"
      });
      cursor.select('.placemark').attr({
        transform: "scale(" + (1 / d3.event.scale) + ") scale(0.2) rotate(60)"
      });
      /* LOD
      */

      return _update_lod(d3.event.scale);
    }));
    vis = zoom_layer.append('g').attr({
      transform: 'translate(22,-34) rotate(-60)'
    });
    map_layer = vis.append('g');
    sea_layer = map_layer.append('g');
    untyped_layer = map_layer.append('g').attr({
      transform: "translate(" + UNTYPED_DX + "," + UNTYPED_DY + ")"
    });
    untyped_land_layer = untyped_layer.append('g');
    land_layer = map_layer.append('g');
    leaf_labels_layer = map_layer.append('g');
    relations_layer = map_layer.append('g');
    relations_layer.append('g').attr({
      "class": 'links'
    });
    cities_layer = map_layer.append('g');
    region_labels_layer = map_layer.append('g');
    cursor_layer = map_layer.append('g');
    /* cursor
    */

    cursor = cursor_layer.append('g').attr({
      "class": 'cursor'
    }).style({
      display: 'none'
    });
    cursor.append('path').attr({
      "class": 'hex_cell',
      d: _hex_path
    });
    placemark = cursor.append('g').attr({
      "class": 'placemark',
      transform: 'scale(0.2) rotate(60)'
    });
    placemark.append('path').attr({
      "class": 'placemark_symbol',
      d: 'm 0,-16 c -3.1862583,0 -5.7692313,2.583 -5.7692313,5.7692 0,1.3042 0.424081,2.4953 1.153846,3.4616 L 0,0 l 4.615385,-6.7692 c 0.729765,-0.9663 1.153846,-2.1574 1.153846,-3.4616 0,-3.1862 -2.582973,-5.7692 -5.769231,-5.7692 z'
    });
    placemark.append('circle').attr({
      "class": 'placemark_dot',
      cy: -10,
      r: 2.1
    });
    land_layer.on('click', function() {
      return _on_hex_click(_get_hexagon(d3.mouse(this)), true);
    });
    return untyped_land_layer.on('click', function() {
      return _on_hex_click(_get_hexagon(d3.mouse(this)), false);
    });
  };

  _on_hex_click = function(hex, typed) {
    if (d3.event.defaultPrevented) {
      return;
    }
    /* move the cursor to provide feedback
    */

    _move_cursor(hex[0], hex[1], typed);
    /* trigger a selection event
    */

    return trigger(map.node, 'select', {
      i: hex[0],
      j: hex[1]
    });
  };

  /* custom projection to make hexagons appear regular (y axis is also flipped)
  */


  dx = CELL_RADIUS * 2 * Math.sin(Math.PI / 3);

  dy = CELL_RADIUS * 1.5;

  SIMPLIFICATION = 400;

  path_generator = d3.geo.path().projection(d3.geo.transform({
    point: function(x, y, z) {
      /* Level of Detail
      */
      if (z >= SIMPLIFICATION) {
        return this.stream.point(x * dx / 2, -(y - (2 - (y & 1)) / 3) * dy / 2);
      }
    }
  }));

  map.load = function(data, untyped_data, stats_data) {
    var cities, cities_data, enter_cities, enter_region_labels, enter_region_labels_foreground, enter_region_labels_halo, region_clips, region_labels, untyped_island, untyped_label, ux, uy, _ref;
    _preprocess(data, untyped_data, stats_data);
    _init_modes();
    /* fill the sea
    */

    /* cover the sea with a pattern
    */

    sea_layer.append('rect').attr({
      id: 'sea',
      width: 10000,
      height: 10000,
      x: -5000,
      y: -5000,
      fill: 'url(#sea_pattern)',
      transform: 'scale(0.05) rotate(60)'
    });
    /* define the level zero region (the land)
    */

    defs.append('path').datum(topojson.mesh(data, data.objects.leaf_regions, function(a, b) {
      return a === b;
    })).attr('id', 'land').attr('d', path_generator);
    /* faux land glow (using filters takes too much resources)
    */

    sea_layer.append('use').attr('class', 'land-glow-outer').attr('xlink:href', '#land');
    sea_layer.append('use').attr('class', 'land-glow-inner').attr('xlink:href', '#land');
    /* draw the untyped island
    */

    untyped_island = untyped_land_layer.selectAll('.untyped_island').data(topojson.feature(untyped_data, untyped_data.objects.untyped_region).features);
    untyped_island.enter().append('path').attr({
      "class": 'untyped_island',
      d: path_generator
    });
    _ref = path_generator.centroid(topojson.feature(untyped_data, untyped_data.objects.untyped_region).features[0].geometry), ux = _ref[0], uy = _ref[1];
    untyped_label = untyped_land_layer.append('g').attr({
      "class": 'untyped_island_label region_label',
      transform: "translate(" + (ux - 1) + "," + (uy + 1) + ")"
    });
    untyped_label.append('text').text('untyped instances').attr({
      "class": 'label halo',
      dx: 0.5,
      dy: -0.5,
      transform: 'rotate(60)'
    });
    untyped_label.append('text').text('untyped instances').attr({
      "class": 'label foreground',
      dx: 0.5,
      dy: -0.5,
      transform: 'rotate(60)'
    });
    /* actual regions
    */

    land_layer.selectAll('.leaf_region').data(topojson.feature(data, data.objects.leaf_regions).features).enter().append('path').attr({
      "class": 'leaf_region',
      d: path_generator
    });
    /* draw the leaf regions boundaries
    */

    land_layer.append('path').datum(topojson.mesh(data, data.objects.leaf_regions, function(a, b) {
      return a !== b && a.properties.path[1] === b.properties.path[1];
    })).attr('d', path_generator).attr('class', 'boundary low').style('stroke-width', '0.5px');
    /* draw the level two boundaries
    */

    land_layer.append('path').datum(topojson.mesh(data, data.objects.leaf_regions, function(a, b) {
      return a.properties.path.length > 2 && b.properties.path.length > 2 && a.properties.path[1] === b.properties.path[1] && a.properties.path[2] !== b.properties.path[2];
    })).attr('d', path_generator).attr('class', 'boundary low').style('stroke-width', '0.9px');
    /* inset clipping of level one regions
    */

    region_clips = land_layer.selectAll('.region_clip').data(ontology.levels[1]);
    region_clips.enter().append('clipPath').attr({
      "class": 'region_clip',
      id: function(n) {
        return "region_clip-" + n.name;
      }
    }).append('path').attr({
      d: function(n) {
        return path_generator(n.merged_region);
      }
    });
    land_layer.selectAll('.high_region').data(ontology.levels[1]).enter().append('path').attr({
      "class": 'high_region',
      d: function(n) {
        return path_generator(n.merged_region);
      },
      'clip-path': function(n) {
        return "url(#region_clip-" + n.name + ")";
      }
    });
    /* draw the high-level boundaries
    */

    land_layer.append('path').datum(topojson.mesh(data, data.objects.leaf_regions, function(a, b) {
      return a === b || a.properties.path[1] !== b.properties.path[1];
    })).attr('d', path_generator).attr('class', 'boundary high').style('stroke-width', '1.1px');
    /* draw labels of leaf regions
    */

    _draw_leaf_labels();
    /* draw notable entities (cities)
    */

    cities_data = [
      {
        "uri": "http://dbpedia.org/resource/Isaac_Newton",
        "i": 573,
        "j": -865
      }, {
        "uri": "http://dbpedia.org/resource/Pablo_Picasso",
        "i": 1365,
        "j": -1237
      }, {
        "uri": "http://dbpedia.org/resource/Rome",
        "i": 72,
        "j": -519
      }, {
        "uri": "http://dbpedia.org/resource/New_York_City",
        "i": 353,
        "j": -453
      }, {
        "uri": "http://dbpedia.org/resource/Earth",
        "i": -1225,
        "j": -1047
      }, {
        "uri": "http://dbpedia.org/resource/Microsoft",
        "i": 264,
        "j": -1060
      }, {
        "uri": "http://dbpedia.org/resource/Google",
        "i": 7,
        "j": -1110
      }, {
        "uri": "http://dbpedia.org/resource/Apple_Inc.",
        "i": 106,
        "j": -1042
      }, {
        "uri": "http://dbpedia.org/resource/Pink_Floyd",
        "i": -126,
        "j": -1518
      }, {
        "uri": "http://dbpedia.org/resource/Yale_University",
        "i": 89,
        "j": -1227
      }, {
        "uri": "http://dbpedia.org/resource/CNN",
        "i": 473,
        "j": -1203
      }, {
        "uri": "http://dbpedia.org/resource/Dog",
        "i": -278,
        "j": -897
      }, {
        "uri": "http://dbpedia.org/resource/Mosquito",
        "i": -419,
        "j": -880
      }, {
        "uri": "http://dbpedia.org/resource/Bamboo",
        "i": -896,
        "j": -844
      }, {
        "uri": "http://dbpedia.org/resource/Crow",
        "i": -856,
        "j": -1253
      }, {
        "uri": "http://dbpedia.org/resource/Tulip",
        "i": -880,
        "j": -1062
      }, {
        "uri": "http://dbpedia.org/resource/The_Matrix",
        "i": -900,
        "j": -503
      }, {
        "uri": "http://dbpedia.org/resource/Yesterday",
        "i": -802,
        "j": -724
      }, {
        "uri": "http://dbpedia.org/resource/The_Wall",
        "i": -331,
        "j": -519
      }, {
        "uri": "http://dbpedia.org/resource/Scott_Pilgrim",
        "i": -728,
        "j": -646
      }, {
        "uri": "http://dbpedia.org/resource/Images_and_Words",
        "i": -558,
        "j": -636
      }, {
        "uri": "http://dbpedia.org/resource/Pizza",
        "i": -1227,
        "j": -873
      }, {
        "uri": "http://dbpedia.org/resource/Christopher_Columbus",
        "i": -350,
        "j": -1461
      }, {
        "uri": "http://dbpedia.org/resource/Cantonese",
        "i": -299,
        "j": -2043
      }, {
        "uri": "http://dbpedia.org/resource/Euro",
        "i": -185,
        "j": -1989
      }, {
        "uri": "http://dbpedia.org/resource/Jews",
        "i": -287,
        "j": -1944
      }, {
        "uri": "http://dbpedia.org/resource/Oscar_Wilde",
        "i": 1226,
        "j": -1199
      }, {
        "uri": "http://dbpedia.org/resource/IPhone",
        "i": -1291,
        "j": -901
      }, {
        "uri": "http://dbpedia.org/resource/Adenosine_triphosphate",
        "i": -1182,
        "j": -1233
      }, {
        "uri": "http://dbpedia.org/resource/Pneumonia",
        "i": -1012,
        "j": -1154
      }, {
        "uri": "http://dbpedia.org/resource/Michael_Jordan",
        "i": 1043,
        "j": -802
      }, {
        "uri": "http://dbpedia.org/resource/Elizabeth_II",
        "i": 1421,
        "j": -1282
      }, {
        "uri": "http://dbpedia.org/resource/Julian_Assange",
        "i": -454,
        "j": -1585
      }, {
        "uri": "http://dbpedia.org/resource/Alan_Turing",
        "i": 667,
        "j": -847
      }, {
        "uri": "http://dbpedia.org/resource/Winston_Churchill",
        "i": 464,
        "j": -1042
      }, {
        "uri": "http://dbpedia.org/resource/Stanley_Kubrick",
        "i": 464,
        "j": -1451
      }, {
        "uri": "http://dbpedia.org/resource/Freddie_Mercury",
        "i": 1232,
        "j": -918
      }
    ];
    cities = cities_layer.selectAll('.city').data(cities_data);
    enter_cities = cities.enter().append('g').on('click', function(c) {
      /* trigger the selection of the city
      */
      return trigger(map.node, 'select', {
        uri: c.uri
      });
    }).attr({
      "class": 'city',
      transform: function(c) {
        var x, y, _ref1;
        _ref1 = _ij_to_xy(c.i, c.j), x = _ref1[0], y = _ref1[1];
        return "translate(" + x + "," + y + ")";
      }
    });
    enter_cities.append('text').text(function(c) {
      return decodeURI(c.uri.replace('http://dbpedia.org/resource/', '').replace(/_/g, ' '));
    }).attr({
      "class": 'label halo',
      dx: 0.5,
      dy: -0.5,
      transform: 'rotate(60)'
    });
    enter_cities.append('text').text(function(c) {
      return decodeURI(c.uri.replace('http://dbpedia.org/resource/', '').replace(/_/g, ' '));
    }).attr({
      "class": 'label foreground',
      dx: 0.5,
      dy: -0.5,
      transform: 'rotate(60)'
    });
    enter_cities.append('path').attr({
      "class": 'hex_cell',
      d: _hex_path
    });
    /* region labels
    */

    region_labels = region_labels_layer.selectAll('.region_label').data(ontology.levels[1].filter(function(n) {
      return n.merged_region.coordinates.length > 0;
    }));
    enter_region_labels = region_labels.enter().append('g').attr({
      "class": 'region_label',
      transform: function(n) {
        return "translate(" + n.x + "," + n.y + ")";
      }
    });
    enter_region_labels_halo = enter_region_labels.append('text').attr({
      "class": 'halo label',
      transform: 'rotate(60)',
      y: function(n) {
        return -(Math.floor(n.readable_label.length / 2) * 1.2 + 0.35) + 'em';
      }
    });
    enter_region_labels_halo.selectAll('tspan').data(function(n) {
      return n.readable_label;
    }).enter().append('tspan').text(function(t) {
      return t;
    }).attr({
      x: 0,
      dy: '1.2em'
    });
    enter_region_labels_foreground = enter_region_labels.append('text').attr({
      "class": 'label foreground',
      transform: 'rotate(60)',
      y: function(n) {
        return -(Math.floor(n.readable_label.length / 2) * 1.2 + 0.35) + 'em';
      }
    });
    enter_region_labels_foreground.selectAll('tspan').data(function(n) {
      return n.readable_label;
    }).enter().append('tspan').text(function(t) {
      return t;
    }).attr({
      x: 0,
      dy: '1.2em'
    });
    map.mode('classes');
    return _update_lod(1);
  };

  map.update_selection = function(selection) {
    var enter_relations, links, relations;
    _preprocess_selection(selection);
    _move_cursor(selection.i, selection.j, selection.parent !== null);
    /* clear all relations and draw them again
    */

    relations_layer.selectAll('.relation_end').remove();
    relations_layer.select('.links').selectAll('.link').remove();
    relations = relations_layer.selectAll('.relation').data(selection.relations);
    enter_relations = relations.enter().append('path').attr({
      "class": 'relation_end hex_cell',
      d: _hex_path,
      transform: function(r) {
        return "translate(" + r.end.x + "," + r.end.y + ")";
      }
    }).on('click', function(r) {
      /* trigger the selection of the relation end
      */
      return trigger(map.node, 'select', {
        uri: r.end.uri
      });
    });
    enter_relations.append('title').text(function(r) {
      return format_uri(r.end.uri);
    });
    /* show relation links
    */

    links = relations_layer.select('.links').selectAll('.link').data(selection.relations);
    return links.enter().append('path').attr({
      "class": 'link',
      d: function(r) {
        return "M" + r.start.x + " " + r.start.y + " L" + r.end.x + " " + r.end.y;
      }
    });
  };

  _ij_to_xy = function(i, j, typed) {
    if (!(typed != null)) {
      typed = true;
    }
    dx = 0;
    dy = 0;
    if (!typed) {
      dx = UNTYPED_DX;
      dy = UNTYPED_DY;
    }
    return [j * (cos30 * CELL_RADIUS * 2) + (i % 2 === 0 ? 0 : cos30 * CELL_RADIUS) + dx, i * 3 / 2 * CELL_RADIUS + dy];
  };

  _move_cursor = function(i, j, typed) {
    var x, y, _ref;
    if (!(typed != null)) {
      typed = true;
    }
    _ref = _ij_to_xy(i, j, typed), x = _ref[0], y = _ref[1];
    return cursor.attr({
      transform: "translate(" + x + ", " + y + ")"
    }).style({
      display: 'inline'
    });
  };

  /* find a hex given SVG coordinates
  */


  GRID_HEIGHT = sin30 * CELL_RADIUS * 3;

  GRID_WIDTH = cos30 * CELL_RADIUS * 2;

  C = sin30 * CELL_RADIUS;

  M = C / (GRID_WIDTH / 2);

  _get_hexagon = function(point) {
    var column, relX, relY, row, rowIsOdd, x, y;
    x = point[0] + cos30 * CELL_RADIUS;
    y = point[1] + CELL_RADIUS;
    row = Math.floor(y / GRID_HEIGHT);
    rowIsOdd = row % 2 === 1;
    if (rowIsOdd) {
      column = Math.floor((x - GRID_WIDTH / 2) / GRID_WIDTH);
    } else {
      column = Math.floor(x / GRID_WIDTH);
    }
    relY = y - (row * GRID_HEIGHT);
    if (rowIsOdd) {
      relX = x - (column * GRID_WIDTH) - GRID_WIDTH / 2;
    } else {
      relX = x - (column * GRID_WIDTH);
    }
    /* work out if the point is above either of the hexagon's top edges
    */

    if (relY < (-M * relX) + C) {
      row -= 1;
      if (!rowIsOdd) {
        column -= 1;
      }
    } else if (relY < (M * relX) - C) {
      row -= 1;
      if (rowIsOdd) {
        column += 1;
      }
    }
    return [row, column];
  };

  /* precomputed hexagonal path
  */


  _hex_path = "M0," + CELL_RADIUS + " L" + (cos30 * CELL_RADIUS) + "," + (sin30 * CELL_RADIUS) + " L" + (cos30 * CELL_RADIUS) + "," + (-sin30 * CELL_RADIUS) + " L0," + (-CELL_RADIUS) + " L" + (-cos30 * CELL_RADIUS) + "," + (-sin30 * CELL_RADIUS) + " L" + (-cos30 * CELL_RADIUS) + "," + (sin30 * CELL_RADIUS) + " Z";

  /* Level Of Detail
  */


  REGION_LABEL_MIN_AREA = 80;

  _update_lod = function(z) {
    //console.log(z);
    
    region_labels_layer.selectAll('.region_label').classed('hidden', function(n) {
      return n.area * z * z < REGION_LABEL_MIN_AREA;
    });
    return leaf_labels_layer.selectAll('.leaf_label').classed('hidden', function(n) {
      return n.area * z * z < REGION_LABEL_MIN_AREA;
    });
  };

  _preprocess = function(data, untyped_data, stats_data) {
    var geometries, _merge, _readable_labels, _stats;
    map.leaf_regions = topojson.feature(data, data.objects.leaf_regions).features;
    geometries = data.objects.leaf_regions.geometries;
    /* parse paths into arrays, and extract the class of each leaf region
    */

    map.leaf_regions.forEach(function(f) {
      f.properties.path = JSON.parse(f.properties.path);
      return f.properties["class"] = f.properties.path[f.properties.path.length - 1];
    });
    /* presimplify the topologies (compute the effective area (z) of each point)
    */

    topojson.presimplify(data);
    topojson.presimplify(untyped_data);
    /* store all leaf_regions into the ontology tree, and store each node within the feature's properties
    */

    map.leaf_regions.forEach(function(f) {
      var n;
      n = ontology.get_node_from_class(f.properties["class"]);
      n.leaf_region = f;
      return f.properties.node = n;
    });
    /* compute merged regions from leaf regions
    */

    _merge = function(n, depth) {
      n.merged_region = topojson.merge(data, geometries.filter(function(g) {
        return g.properties.path.length > depth && g.properties.path[depth] === n.name;
      }));
      if (n.children != null) {
        return n.children.forEach(function(c) {
          return _merge(c, depth + 1);
        });
      }
    };
    _merge(ontology.tree, 0);
    /* compute all region centroids
    */

    ontology.nodes.forEach(function(n) {
      var _ref;
      return _ref = path_generator.centroid(n.merged_region), n.x = _ref[0], n.y = _ref[1], _ref;
    });
    /* compute all region areas
    */

    ontology.nodes.forEach(function(n) {
      return n.area = path_generator.area(n.merged_region);
    });
    /* create a stats index
    */

    _stats = {};
    stats_data.forEach(function(s) {
      return _stats[s["class"]] = s;
    });
    /* add stats to each leaf region
    */

    map.leaf_regions.forEach(function(f) {
      f.properties.node.stats = _stats[f.properties.node.name];
      if (!(f.properties.node.stats != null)) {
        return console.error("Class not found in statistics data: " + f.properties.node.name);
      }
    });
    /* compute additional stats
    */

    map.leaf_regions.forEach(function(f) {
      f.properties.node.stats.triple_density = f.properties.node.stats.triple_count / f.properties.node.leaf_count;
      f.properties.node.stats.obj_props_density = f.properties.node.stats.obj_props_count / f.properties.node.leaf_count;
      return f.properties.node.stats.data_props_density = f.properties.node.stats.data_props_count / f.properties.node.leaf_count;
    });
    /* define readable, plural, multiline labels for level one regions
    */

    _readable_labels = {
      'http://dbpedia.org/ontology/Place': ['Places'],
      'http://dbpedia.org/ontology/Agent': ['Agents'],
      'http://dbpedia.org/ontology/Event': ['Events'],
      'http://dbpedia.org/ontology/Species': ['Species'],
      'http://dbpedia.org/ontology/Work': ['Works'],
      'http://dbpedia.org/ontology/SportsSeason': ['Sports', 'Seasons'],
      'http://dbpedia.org/ontology/UnitOfWork': ['Units of', 'Work'],
      'http://dbpedia.org/ontology/TopicalConcept': ['Topical', 'Concepts'],
      'http://dbpedia.org/ontology/Biomolecule': ['Biomolecules'],
      'http://dbpedia.org/ontology/Activity': ['Activities'],
      'http://dbpedia.org/ontology/Food': ['Food'],
      'http://dbpedia.org/ontology/MeanOfTransportation': ['Means of', 'Transportation'],
      'http://dbpedia.org/ontology/Device': ['Devices'],
      'http://dbpedia.org/ontology/CelestialBody': ['Celestial', 'Bodies'],
      'http://dbpedia.org/ontology/ChemicalSubstance': ['Chemical', 'Substances'],
      'http://dbpedia.org/ontology/Medicine': ['Medicine'],
      'http://dbpedia.org/ontology/TimePeriod': ['Time', 'Periods'],
      'http://dbpedia.org/ontology/Satellite': ['Satellites'],
      'http://dbpedia.org/ontology/SportCompetitionResult': ['Sport', 'Competition', 'Results'],
      'http://dbpedia.org/ontology/AnatomicalStructure': ['Anatomical', 'Structures'],
      'http://dbpedia.org/ontology/GeneLocation': ['Gene', 'Locations'],
      'http://dbpedia.org/ontology/CareerStation': ['Career', 'Stations'],
      'http://dbpedia.org/ontology/PersonFunction': ['Person', 'Functions'],
      'http://www.opengis.net/gml/_Feature': ['gml:feature'],
      'http://dbpedia.org/ontology/Language': ['Languages'],
      'http://dbpedia.org/ontology/Sales': ['Sales'],
      'http://dbpedia.org/ontology/Drug': ['Drugs'],
      'http://dbpedia.org/ontology/EthnicGroup': ['Ethnic', 'Groups'],
      'http://dbpedia.org/ontology/Award': ['Awards'],
      'http://dbpedia.org/ontology/Colour': ['Colours'],
      'http://dbpedia.org/ontology/Holiday': ['Holidays'],
      'http://dbpedia.org/ontology/Currency': ['Currencies'],
      'http://dbpedia.org/ontology/SnookerWorldRanking': ['Snooker', 'World', 'Rankings'],
      'http://dbpedia.org/ontology/Swarm': ['Swarms'],
      'http://dbpedia.org/ontology/Competition': ['Competitions'],
      'http://dbpedia.org/ontology/List': ['Lists'],
      'http://dbpedia.org/ontology/Name': ['Names'],
      'http://dbpedia.org/ontology/Diocese': ['Dioceses'],
      'http://dbpedia.org/ontology/Village': ['Villages'],
      'http://dbpedia.org/ontology/Town': ['Towns'],
      'http://dbpedia.org/ontology/City': ['Cities'],
      'http://dbpedia.org/ontology/Island': ['Islands'],
      'http://dbpedia.org/ontology/Country': ['Countries'],
      'http://dbpedia.org/ontology/Continent': ['Continents'],
      'http://dbpedia.org/ontology/River': ['Rivers'],
      'http://dbpedia.org/ontology/Canal': ['Canals'],
      'http://dbpedia.org/ontology/Lake': ['Lakes'],
      'http://dbpedia.org/ontology/Mountain': ['Mountains'],
      'http://dbpedia.org/ontology/MountainRange': ['Mountain', 'Ranges'],
      'http://dbpedia.org/ontology/Crater': ['Craters'],
      'http://dbpedia.org/ontology/MountainPass': ['Mountain', 'Passes'],
      'http://dbpedia.org/ontology/Volcano': ['Volcanoes'],
      'http://dbpedia.org/ontology/Glacier': ['Glaciers'],
      'http://dbpedia.org/ontology/Cave': ['Caves'],
      'http://dbpedia.org/ontology/Valley': ['Valleys'],
      'http://dbpedia.org/ontology/Road': ['Roads'],
      'http://dbpedia.org/ontology/Bridge': ['Bridges'],
      'http://dbpedia.org/ontology/RailwayLine': ['Railway', 'Lines'],
      'http://dbpedia.org/ontology/RoadTunnel': ['Road', 'Tunnels'],
      'http://dbpedia.org/ontology/RoadJunction': ['Road', 'Junctions'],
      'http://dbpedia.org/ontology/RailwayTunnel': ['Railway', 'Tunnels'],
      'http://dbpedia.org/ontology/WaterwayTunnel': ['Waterway', 'Tunnels'],
      'http://dbpedia.org/ontology/RailwayStation': ['Railway', 'Stations'],
      'http://dbpedia.org/ontology/Airport': ['Airports'],
      'http://dbpedia.org/ontology/Dam': ['Dams'],
      'http://dbpedia.org/ontology/PowerStation': ['Power', 'Stations'],
      'http://dbpedia.org/ontology/LaunchPad': ['Launch', 'Pads'],
      'http://dbpedia.org/ontology/HistoricBuilding': ['Historic', 'Buildings'],
      'http://dbpedia.org/ontology/Museum': ['Museums'],
      'http://dbpedia.org/ontology/ReligiousBuilding': ['Religious', 'Buildings'],
      'http://dbpedia.org/ontology/Hospital': ['Hospitals'],
      'http://dbpedia.org/ontology/ShoppingMall': ['Shopping', 'Malls'],
      'http://dbpedia.org/ontology/Castle': ['Castles'],
      'http://dbpedia.org/ontology/Restaurant': ['Restaurants'],
      'http://dbpedia.org/ontology/Hotel': ['Hotels'],
      'http://dbpedia.org/ontology/Prison': ['Prisons'],
      'http://dbpedia.org/ontology/Skyscraper': ['Skyscrapers'],
      'http://dbpedia.org/ontology/Lighthouse': ['Lighthouses'],
      'http://dbpedia.org/ontology/Theatre': ['Theatres'],
      'http://dbpedia.org/ontology/RollerCoaster': ['Roller', 'Coasters'],
      'http://dbpedia.org/ontology/WaterRide': ['Water', 'Rides'],
      'http://dbpedia.org/ontology/MilitaryStructure': ['Military', 'Structures'],
      'http://dbpedia.org/ontology/Tunnel': ['Tunnels'],
      'http://dbpedia.org/ontology/Racecourse': ['Racecourses'],
      'http://dbpedia.org/ontology/Stadium': ['Stadiums'],
      'http://dbpedia.org/ontology/GolfCourse': ['Golf', 'Courses'],
      'http://dbpedia.org/ontology/CricketGround': ['Cricket', 'Grounds'],
      'http://dbpedia.org/ontology/HistoricPlace': ['Historic', 'Places'],
      'http://dbpedia.org/ontology/ProtectedArea': ['Protected', 'Areas'],
      'http://dbpedia.org/ontology/Park': ['Parks'],
      'http://dbpedia.org/ontology/WorldHeritageSite': ['World', 'Heritage', 'Sites'],
      'http://dbpedia.org/ontology/SiteOfSpecialScientificInterest': ['Sites of Special', 'Scientific Interest'],
      'http://dbpedia.org/ontology/SkiArea': ['Ski', 'Areas'],
      'http://dbpedia.org/ontology/Garden': ['Gardens'],
      'http://dbpedia.org/ontology/Monument': ['Monuments'],
      'http://dbpedia.org/ontology/WineRegion': ['Wine', 'Regions'],
      'http://dbpedia.org/ontology/NascarDriver': ['Nascar', 'Drivers'],
      'http://dbpedia.org/ontology/FormulaOneRacer': ['Formula One', 'Racers'],
      'http://dbpedia.org/ontology/SpeedwayRider': ['Speedway', 'Riders'],
      'http://dbpedia.org/ontology/AmericanFootballPlayer': ['American', 'Football', 'Players'],
      'http://dbpedia.org/ontology/SumoWrestler': ['Sumo', 'Wrestlers'],
      'http://dbpedia.org/ontology/AmateurBoxer': ['Amateur', 'Boxers'],
      'http://dbpedia.org/ontology/BeachVolleyballPlayer': ['Beach', 'Volleyball', 'Players'],
      'http://dbpedia.org/ontology/SnookerChamp': ['Snooker', 'Champs'],
      'http://dbpedia.org/ontology/SoccerPlayer': ['Soccer', 'Players'],
      'http://dbpedia.org/ontology/BaseballPlayer': ['Baseball', 'Players'],
      'http://dbpedia.org/ontology/IceHockeyPlayer': ['Ice Hockey', 'Players'],
      'http://dbpedia.org/ontology/Cricketer': ['Cricketers'],
      'http://dbpedia.org/ontology/RugbyPlayer': ['Rugby', 'Players'],
      'http://dbpedia.org/ontology/BasketballPlayer': ['Basketball', 'Players'],
      'http://dbpedia.org/ontology/AustralianRulesFootballPlayer': ['Australian Rules', 'Football Players'],
      'http://dbpedia.org/ontology/Cyclist': ['Cyclists'],
      'http://dbpedia.org/ontology/TennisPlayer': ['Tennis', 'Players'],
      'http://dbpedia.org/ontology/Swimmer': ['Swimmers'],
      'http://dbpedia.org/ontology/GaelicGamesPlayer': ['Gaelic', 'Games', 'Players'],
      'http://dbpedia.org/ontology/FigureSkater': ['Figure', 'Skaters'],
      'http://dbpedia.org/ontology/MartialArtist': ['Martial', 'Artists'],
      'http://dbpedia.org/ontology/GolfPlayer': ['Golf', 'Players'],
      'http://dbpedia.org/ontology/Skier': ['Skiers'],
      'http://dbpedia.org/ontology/HandballPlayer': ['Handball', 'Players'],
      'http://dbpedia.org/ontology/ChessPlayer': ['Chess', 'Players'],
      'http://dbpedia.org/ontology/Gymnast': ['Gymnasts'],
      'http://dbpedia.org/ontology/PokerPlayer': ['Poker', 'Players'],
      'http://dbpedia.org/ontology/BadmintonPlayer': ['Badminton', 'Players'],
      'http://dbpedia.org/ontology/Curler': ['Curlers'],
      'http://dbpedia.org/ontology/Canoeist': ['Canoeists'],
      'http://dbpedia.org/ontology/Jockey': ['Jockeys'],
      'http://dbpedia.org/ontology/DartsPlayer': ['Darts', 'Players'],
      'http://dbpedia.org/ontology/TableTennisPlayer': ['Table', 'Tennis', 'Player'],
      'http://dbpedia.org/ontology/HorseRider': ['Horse', 'Riders'],
      'http://dbpedia.org/ontology/SquashPlayer': ['Squash', 'Players'],
      'http://dbpedia.org/ontology/LacrossePlayer': ['Lacrosse', 'Players'],
      'http://dbpedia.org/ontology/Skater': ['Skaters'],
      'http://dbpedia.org/ontology/NationalCollegiateAthleticAssociationAthlete': ['National Collegiate', 'Athletic Association', 'Athletes'],
      'http://dbpedia.org/ontology/Rower': ['Rowers'],
      'http://dbpedia.org/ontology/NetballPlayer': ['Netball', 'Players'],
      'http://dbpedia.org/ontology/Bodybuilder': ['Bodybuilders'],
      'http://dbpedia.org/ontology/Guitarist': ['Guitarists'],
      'http://dbpedia.org/ontology/ClassicalMusicArtist': ['Classical Music', 'Artists'],
      'http://dbpedia.org/ontology/AdultActor': ['Adult', 'Actors'],
      'http://dbpedia.org/ontology/VoiceActor': ['Voice', 'Actors'],
      'http://dbpedia.org/ontology/ScreenWriter': ['Screen', 'Writers'],
      'http://dbpedia.org/ontology/Poet': ['Poets'],
      'http://dbpedia.org/ontology/Painter': ['Painters'],
      'http://dbpedia.org/ontology/ComicsCreator': ['Comics', 'Creators'],
      'http://dbpedia.org/ontology/Comedian': ['Comedians'],
      'http://dbpedia.org/ontology/FashionDesigner': ['Fashion', 'Designers'],
      'http://dbpedia.org/ontology/Photographer': ['Photographers'],
      'http://dbpedia.org/ontology/Baronet': ['Baronets'],
      'http://dbpedia.org/ontology/AnimangaCharacter': ['Animanga', 'Characters'],
      'http://dbpedia.org/ontology/SoapCharacter': ['Soap', 'Characters'],
      'http://dbpedia.org/ontology/SportsTeamMember': ['Sports Team', 'Members'],
      'http://dbpedia.org/ontology/SoccerManager': ['Soccer', 'Managers'],
      'http://dbpedia.org/ontology/MemberOfParliament': ['Member of', 'Parliament'],
      'http://dbpedia.org/ontology/Congressman': ['Congressmen'],
      'http://dbpedia.org/ontology/Governor': ['Governors'],
      'http://dbpedia.org/ontology/President': ['Presidents'],
      'http://dbpedia.org/ontology/Mayor': ['Mayors'],
      'http://dbpedia.org/ontology/PrimeMinister': ['Prime', 'Ministers'],
      'http://dbpedia.org/ontology/Senator': ['Senators'],
      'http://dbpedia.org/ontology/Chancellor': ['Chancellors'],
      'http://dbpedia.org/ontology/CollegeCoach': ['College', 'Coaches'],
      'http://dbpedia.org/ontology/AmericanFootballCoach': ['American', 'Football', 'Coaches'],
      'http://dbpedia.org/ontology/VolleyballCoach': ['Volleyball', 'Coaches'],
      'http://dbpedia.org/ontology/ChristianBishop': ['Christian', 'Bishops'],
      'http://dbpedia.org/ontology/Saint': ['Saints'],
      'http://dbpedia.org/ontology/Cardinal': ['Cardinals'],
      'http://dbpedia.org/ontology/Pope': ['Popes'],
      'http://dbpedia.org/ontology/Entomologist': ['Entomologists'],
      'http://dbpedia.org/ontology/Medician': ['Medicians'],
      'http://dbpedia.org/ontology/RadioHost': ['Radio', 'Hosts'],
      'http://dbpedia.org/ontology/TelevisionHost': ['Television', 'Hosts'],
      'http://dbpedia.org/ontology/Murderer': ['Murderers'],
      'http://dbpedia.org/ontology/OfficeHolder': ['Office', 'Holders'],
      'http://dbpedia.org/ontology/MilitaryPerson': ['Military', 'People'],
      'http://dbpedia.org/ontology/Noble': ['Nobles'],
      'http://dbpedia.org/ontology/Monarch': ['Monarchs'],
      'http://dbpedia.org/ontology/Judge': ['Judges'],
      'http://dbpedia.org/ontology/Architect': ['Architects'],
      'http://dbpedia.org/ontology/BeautyQueen': ['Beauty', 'Queens'],
      'http://dbpedia.org/ontology/Journalist': ['Journalists'],
      'http://dbpedia.org/ontology/Philosopher': ['Philosophers'],
      'http://dbpedia.org/ontology/Model': ['Models'],
      'http://dbpedia.org/ontology/BusinessPerson': ['Business', 'People'],
      'http://dbpedia.org/ontology/Economist': ['Economists'],
      'http://dbpedia.org/ontology/MythologicalFigure': ['Mythological', 'Figures'],
      'http://dbpedia.org/ontology/Engineer': ['Engineers'],
      'http://dbpedia.org/ontology/Religious': ['Religious'],
      'http://dbpedia.org/ontology/Historian': ['Historians'],
      'http://dbpedia.org/ontology/Astronaut': ['Astronauts'],
      'http://dbpedia.org/ontology/Ambassador': ['Ambassadors'],
      'http://dbpedia.org/ontology/Chef': ['Chefs'],
      'http://dbpedia.org/ontology/PlayboyPlaymate': ['Playboy', 'Playmates'],
      'http://dbpedia.org/ontology/HorseTrainer': ['Horse', 'Trainers'],
      'http://dbpedia.org/ontology/Band': ['Bands'],
      'http://dbpedia.org/ontology/ComedyGroup': ['Comedy', 'Groups'],
      'http://dbpedia.org/ontology/School': ['Schools'],
      'http://dbpedia.org/ontology/University': ['Universities'],
      'http://dbpedia.org/ontology/College': ['Colleges'],
      'http://dbpedia.org/ontology/SoccerClub': ['Soccer', 'Clubs'],
      'http://dbpedia.org/ontology/RugbyClub': ['Rugby', 'Clubs'],
      'http://dbpedia.org/ontology/HockeyTeam': ['Hockey', 'Teams'],
      'http://dbpedia.org/ontology/BasketballTeam': ['Basketball', 'Teams'],
      'http://dbpedia.org/ontology/CricketTeam': ['Cricket', 'Teams'],
      'http://dbpedia.org/ontology/BaseballTeam': ['Baseball', 'Teams'],
      'http://dbpedia.org/ontology/AustralianFootballTeam': ['Australian', 'Football Teams'],
      'http://dbpedia.org/ontology/HandballTeam': ['Handball', 'Teams'],
      'http://dbpedia.org/ontology/CyclingTeam': ['Cycling', 'Teams'],
      'http://dbpedia.org/ontology/FormulaOneTeam': ['Formula', 'One Teams'],
      'http://dbpedia.org/ontology/SpeedwayTeam': ['Speedway', 'Teams'],
      'http://dbpedia.org/ontology/AmericanFootballTeam': ['American', 'Football Teams'],
      'http://dbpedia.org/ontology/CanadianFootballTeam': ['Canadian', 'Football Teams'],
      'http://dbpedia.org/ontology/RadioStation': ['Radio', 'Stations'],
      'http://dbpedia.org/ontology/TelevisionStation': ['Television', 'Stations'],
      'http://dbpedia.org/ontology/BroadcastNetwork': ['Broadcast', 'Networks'],
      'http://dbpedia.org/ontology/Airline': ['Airlines'],
      'http://dbpedia.org/ontology/RecordLabel': ['Record', 'Labels'],
      'http://dbpedia.org/ontology/BusCompany': ['Bus', 'Companies'],
      'http://dbpedia.org/ontology/Publisher': ['Publishers'],
      'http://dbpedia.org/ontology/LawFirm': ['Law', 'Firms'],
      'http://dbpedia.org/ontology/Brewery': ['Breweries'],
      'http://dbpedia.org/ontology/Winery': ['Wineries'],
      'http://dbpedia.org/ontology/SoccerLeague': ['Soccer', 'Leagues'],
      'http://dbpedia.org/ontology/RugbyLeague': ['Rugby', 'Leagues'],
      'http://dbpedia.org/ontology/BasketballLeague': ['Basketball', 'Leagues'],
      'http://dbpedia.org/ontology/IceHockeyLeague': ['Ice Hockey', 'Leagues'],
      'http://dbpedia.org/ontology/BaseballLeague': ['Baseball', 'Leagues'],
      'http://dbpedia.org/ontology/AmericanFootballLeague': ['American', 'Football', 'Leagues'],
      'http://dbpedia.org/ontology/VolleyballLeague': ['Volleyball', 'Leagues'],
      'http://dbpedia.org/ontology/LacrosseLeague': ['Lacrosse', 'Leagues'],
      'http://dbpedia.org/ontology/HandballLeague': ['Handball', 'Leagues'],
      'http://dbpedia.org/ontology/FieldHockeyLeague': ['Field', 'Hockey', 'Leagues'],
      'http://dbpedia.org/ontology/InlineHockeyLeague': ['Inline', 'Hockey', 'Leagues'],
      'http://dbpedia.org/ontology/MotorcycleRacingLeague': ['Motorcycle', 'Racing', 'Leagues'],
      'http://dbpedia.org/ontology/SoftballLeague': ['Softball', 'Leagues'],
      'http://dbpedia.org/ontology/PoloLeague': ['Polo', 'Leagues'],
      'http://dbpedia.org/ontology/SpeedwayLeague': ['Speedway', 'Leagues'],
      'http://dbpedia.org/ontology/GolfLeague': ['Golf', 'Leagues'],
      'http://dbpedia.org/ontology/TennisLeague': ['Tennis', 'Leagues'],
      'http://dbpedia.org/ontology/CricketLeague': ['Cricket', 'Leagues'],
      'http://dbpedia.org/ontology/AutoRacingLeague': ['Auto Racing', 'Leagues'],
      'http://dbpedia.org/ontology/CanadianFootballLeague': ['Canadian', 'Football', 'Leagues'],
      'http://dbpedia.org/ontology/VideogamesLeague': ['Videogames', 'Leagues'],
      'http://dbpedia.org/ontology/AustralianFootballLeague': ['Australian', 'Football Leagues'],
      'http://dbpedia.org/ontology/CurlingLeague': ['Curling', 'Leagues'],
      'http://dbpedia.org/ontology/BowlingLeague': ['Bowling', 'Leagues'],
      'http://dbpedia.org/ontology/MixedMartialArtsLeague': ['Mixed Martial', 'Arts Leagues'],
      'http://dbpedia.org/ontology/MilitaryUnit': ['Military', 'Units'],
      'http://dbpedia.org/ontology/PoliticalParty': ['Political', 'Parties'],
      'http://dbpedia.org/ontology/GovernmentAgency': ['Government', 'Agencies'],
      'http://dbpedia.org/ontology/Non-ProfitOrganisation': ['Non-Profit', 'Organisations'],
      'http://dbpedia.org/ontology/TradeUnion': ['Trade', 'Unions'],
      'http://dbpedia.org/ontology/PublicTransitSystem': ['Public', 'Transit', 'Systems'],
      'http://dbpedia.org/ontology/Legislature': ['Legislatures'],
      'http://dbpedia.org/ontology/SoccerTournament': ['Soccer', 'Tournaments'],
      'http://dbpedia.org/ontology/TennisTournament': ['Tennis', 'Tournaments'],
      'http://dbpedia.org/ontology/GolfTournament': ['Golf', 'Tournaments'],
      'http://dbpedia.org/ontology/WomensTennisAssociationTournament': ['Women\'s Tennis', 'Association Tournaments'],
      'http://dbpedia.org/ontology/OlympicEvent': ['Olympic', 'Events'],
      'http://dbpedia.org/ontology/HorseRace': ['Horse', 'Races'],
      'http://dbpedia.org/ontology/CyclingRace': ['Cycling', 'Races'],
      'http://dbpedia.org/ontology/FootballMatch': ['Football', 'Matches'],
      'http://dbpedia.org/ontology/GrandPrix': ['Grands', 'Prix'],
      'http://dbpedia.org/ontology/WrestlingEvent': ['Wrestling', ' Events'],
      'http://dbpedia.org/ontology/MixedMartialArtsEvent': ['Mixed Martial', 'Arts Events'],
      'http://dbpedia.org/ontology/NationalFootballLeagueEvent': ['National Football', 'League Events'],
      'http://dbpedia.org/ontology/MilitaryConflict': ['Military', 'Conflicts'],
      'http://dbpedia.org/ontology/Election': ['Elections'],
      'http://dbpedia.org/ontology/Convention': ['Conventions'],
      'http://dbpedia.org/ontology/FilmFestival': ['Film', 'Festivals'],
      'http://dbpedia.org/ontology/MusicFestival': ['Music', 'Festivals'],
      'http://dbpedia.org/ontology/SpaceMission': ['Space', 'Missions'],
      'http://dbpedia.org/ontology/SolarEclipse': ['Solar', 'Eclipses'],
      'http://dbpedia.org/ontology/RaceHorse': ['Race', 'Horses'],
      'http://dbpedia.org/ontology/Insect': ['Insects'],
      'http://dbpedia.org/ontology/Mollusca': ['Mollusca'],
      'http://dbpedia.org/ontology/Fish': ['Fishes'],
      'http://dbpedia.org/ontology/Bird': ['Birds'],
      'http://dbpedia.org/ontology/Amphibian': ['Amphibians'],
      'http://dbpedia.org/ontology/Reptile': ['Reptiles'],
      'http://dbpedia.org/ontology/Arachnid': ['Arachnids'],
      'http://dbpedia.org/ontology/Crustacean': ['Crustaceans'],
      'http://dbpedia.org/ontology/Grape': ['Grapes'],
      'http://dbpedia.org/ontology/CultivatedVariety': ['Cultivated', 'Varieties'],
      'http://dbpedia.org/ontology/Fern': ['Ferns'],
      'http://dbpedia.org/ontology/Conifer': ['Conifers'],
      'http://dbpedia.org/ontology/Moss': ['Mosses'],
      'http://dbpedia.org/ontology/GreenAlga': ['Green', 'Algae'],
      'http://dbpedia.org/ontology/Cycad': ['Cycads'],
      'http://dbpedia.org/ontology/ClubMoss': ['Club', 'Mosses'],
      'http://dbpedia.org/ontology/Gnetophytes': ['Gnetophytes'],
      'http://dbpedia.org/ontology/Ginkgo': ['Ginkgos'],
      'http://dbpedia.org/ontology/Fungus': ['Fungi'],
      'http://dbpedia.org/ontology/Bacteria': ['Bacteria'],
      'http://dbpedia.org/ontology/Archaea': ['Archaea'],
      'http://dbpedia.org/ontology/Newspaper': ['Newspapers'],
      'http://dbpedia.org/ontology/AcademicJournal': ['Academic', 'Journals'],
      'http://dbpedia.org/ontology/Magazine': ['Magazines'],
      'http://dbpedia.org/ontology/Novel': ['Novels'],
      'http://dbpedia.org/ontology/Comics': ['Comics'],
      'http://dbpedia.org/ontology/Play': ['Plays'],
      'http://dbpedia.org/ontology/Poem': ['Poems'],
      'http://dbpedia.org/ontology/EurovisionSongContestEntry': ['Eurovision', 'Song Contest', 'Entries'],
      'http://dbpedia.org/ontology/Album': ['Albums'],
      'http://dbpedia.org/ontology/Single': ['Singles'],
      'http://dbpedia.org/ontology/ArtistDiscography': ['Artist', 'Discographies'],
      'http://dbpedia.org/ontology/ClassicalMusicComposition': ['Classical Music', 'Compositions'],
      'http://dbpedia.org/ontology/VideoGame': ['Video', 'Games'],
      'http://dbpedia.org/ontology/ProgrammingLanguage': ['Programming', 'Languages'],
      'http://dbpedia.org/ontology/Anime': ['Anime'],
      'http://dbpedia.org/ontology/HollywoodCartoon': ['Hollywood', 'Cartoons'],
      'http://dbpedia.org/ontology/BiologicalDatabase': ['Biological', 'Databases'],
      'http://dbpedia.org/ontology/Film': ['Films'],
      'http://dbpedia.org/ontology/TelevisionShow': ['Television', 'Shows'],
      'http://dbpedia.org/ontology/TelevisionEpisode': ['Television', 'Episodes'],
      'http://dbpedia.org/ontology/Artwork': ['Artworks'],
      'http://dbpedia.org/ontology/Website': ['Websites'],
      'http://dbpedia.org/ontology/TelevisionSeason': ['Television', 'Seasons'],
      'http://dbpedia.org/ontology/Musical': ['Musicals'],
      'http://dbpedia.org/ontology/RadioProgram': ['Radio', 'Programs'],
      'http://dbpedia.org/ontology/NationalFootballLeagueSeason': ['National Football', 'League Seasons'],
      'http://dbpedia.org/ontology/NCAATeamSeason': ['NCAA Team', 'Seasons'],
      'http://dbpedia.org/ontology/SoccerClubSeason': ['Soccer Club', 'Seasons'],
      'http://dbpedia.org/ontology/BaseballSeason': ['Baseball', 'Seasons'],
      'http://dbpedia.org/ontology/MotorsportSeason': ['Motorsport', 'Seasons'],
      'http://dbpedia.org/ontology/SupremeCourtOfTheUnitedStatesCase': ['Supreme Court of', 'the United States', 'Cases'],
      'http://dbpedia.org/ontology/ResearchProject': ['Research', 'Projects'],
      'http://dbpedia.org/ontology/MusicGenre': ['Music', 'Genres'],
      'http://dbpedia.org/ontology/Fashion': ['Fashion'],
      'http://dbpedia.org/ontology/HumanGene': ['Human', 'Genes'],
      'http://dbpedia.org/ontology/MouseGene': ['Mouse', 'Genes'],
      'http://dbpedia.org/ontology/Protein': ['Proteins'],
      'http://dbpedia.org/ontology/Enzyme': ['Enzyme'],
      'http://dbpedia.org/ontology/Game': ['Games'],
      'http://dbpedia.org/ontology/Cheese': ['Cheese'],
      'http://dbpedia.org/ontology/Ship': ['Ships'],
      'http://dbpedia.org/ontology/Aircraft': ['Aircrafts'],
      'http://dbpedia.org/ontology/Automobile': ['Automobiles'],
      'http://dbpedia.org/ontology/Locomotive': ['Locomotives'],
      'http://dbpedia.org/ontology/Train': ['Trains'],
      'http://dbpedia.org/ontology/Motorcycle': ['Motorcycles'],
      'http://dbpedia.org/ontology/Rocket': ['Rockets'],
      'http://dbpedia.org/ontology/Spacecraft': ['Spacecrafts'],
      'http://dbpedia.org/ontology/SpaceStation': ['Space', 'Stations'],
      'http://dbpedia.org/ontology/SpaceShuttle': ['Space', 'Shuttles'],
      'http://dbpedia.org/ontology/AutomobileEngine': ['Automobile', 'Engines'],
      'http://dbpedia.org/ontology/Weapon': ['Weapons'],
      'http://dbpedia.org/ontology/InformationAppliance': ['Information', 'Appliances'],
      'http://dbpedia.org/ontology/Asteroid': ['Asteroids'],
      'http://dbpedia.org/ontology/Planet': ['Planets'],
      'http://dbpedia.org/ontology/Star': ['Stars'],
      'http://dbpedia.org/ontology/Galaxy': ['Galaxies'],
      'http://dbpedia.org/ontology/ChemicalCompound': ['Chemical', 'Compounds'],
      'http://dbpedia.org/ontology/Mineral': ['Minerals'],
      'http://dbpedia.org/ontology/Disease': ['Diseases'],
      'http://dbpedia.org/ontology/GivenName': ['Given', 'Names'],
      'http://dbpedia.org/ontology/Surname': ['Surnames'],
      'http://dbpedia.org/ontology/Year': ['Years'],
      'http://dbpedia.org/ontology/YearInSpaceflight': ['Years in', 'Spaceflight'],
      'http://dbpedia.org/ontology/ArtificialSatellite': ['Artificial', 'Satellites'],
      'http://dbpedia.org/ontology/OlympicResult': ['Olympic', 'Results'],
      'http://dbpedia.org/ontology/Brain': ['Brains'],
      'http://dbpedia.org/ontology/Bone': ['Bones'],
      'http://dbpedia.org/ontology/Artery': ['Arteries'],
      'http://dbpedia.org/ontology/Nerve': ['Nerve'],
      'http://dbpedia.org/ontology/Muscle': ['Muscle'],
      'http://dbpedia.org/ontology/Vein': ['Veins'],
      'http://dbpedia.org/ontology/Ligament': ['Ligaments'],
      'http://dbpedia.org/ontology/Embryology': ['Embryology'],
      'http://dbpedia.org/ontology/Lymph': ['Lymph'],
      'http://dbpedia.org/ontology/HumanGeneLocation': ['Human Gene', 'Locations'],
      'http://dbpedia.org/ontology/MouseGeneLocation': ['Mouse Gene', 'Locations']
    };
    ontology.levels[1].forEach(function(n) {
      return n.readable_label = _readable_labels[n.name];
    });
    return ontology.leaves.forEach(function(n) {
      if (n.depth > 1 && (n.leaf_region != null)) {
        return n.readable_label = _readable_labels[n.name];
      }
    });
  };

  _preprocess_selection = function(selection) {
    /* compute selection parent, if any
    */

    var _ref;
    if (selection.path.length > 0) {
      selection.parent = ontology.get_node_from_class(selection.path[selection.path.length - 1]);
    } else {
      selection.parent = null;
    }
    /* compute cartesian coordinates
    */

    _ref = _ij_to_xy(selection.i, selection.j, selection.parent != null), selection.x = _ref[0], selection.y = _ref[1];
    /* extract relational links
    */

    /* FIXME links to self are currently ignored
    */

    selection.relations = [];
    /* outgoing links
    */

    selection.object_properties.outgoing.forEach(function(t) {
      var ox, oy, path, _ref1;
      if ('i' in t && 'j' in t) {
        path = ontology.get_path(t.c);
        _ref1 = _ij_to_xy(t.i.value, t.j.value, path.length > 0), ox = _ref1[0], oy = _ref1[1];
        return selection.relations.push({
          source: selection,
          predicate: t.p.value,
          target: {
            uri: t.o.value,
            i: t.i.value,
            j: t.j.value,
            x: ox,
            y: oy,
            parent: path.length > 0 ? ontology.get_node_from_class(path[path.length - 1]) : null
          }
        });
      } else {
        return console.error('Link to out-of-map entity: ' + t.o.value);
      }
    });
    /* incoming links
    */

    selection.object_properties.incoming.forEach(function(t) {
      var path, sx, sy, _ref1;
      if ('i' in t && 'j' in t) {
        path = ontology.get_path(t.c);
        _ref1 = _ij_to_xy(t.i.value, t.j.value, path.length > 0), sx = _ref1[0], sy = _ref1[1];
        return selection.relations.push({
          source: {
            uri: t.s.value,
            i: t.i.value,
            j: t.j.value,
            x: sx,
            y: sy,
            parent: path.length > 0 ? ontology.get_node_from_class(path[path.length - 1]) : null
          },
          predicate: t.p.value,
          target: selection
        });
      } else {
        return console.error('Link from out-of-map entity: ' + t.s.value);
      }
    });
    /* pointers relative to current selection
    */

    return selection.relations.forEach(function(r) {
      if (r.source === selection) {
        r.start = r.source;
        return r.end = r.target;
      } else {
        r.start = r.target;
        return r.end = r.source;
      }
    });
  };

  inset_color = null;

  depth_color = null;

  triple_density_color = null;

  obj_props_density_color = null;

  data_props_density_color = null;

  _init_modes = function() {
    /* classes
    */

    /* WARNING this is done explicitly, to handpick colors for important regions and avoid similar color in neighboring regions
    */

    var classes, colors;
    classes = ["http://dbpedia.org/ontology/MeanOfTransportation", "http://dbpedia.org/ontology/SportsSeason", "http://dbpedia.org/ontology/Agent", "http://dbpedia.org/ontology/Device", "http://dbpedia.org/ontology/Place", "http://dbpedia.org/ontology/Biomolecule", "http://dbpedia.org/ontology/Species", "http://www.opengis.net/gml/_Feature", "http://dbpedia.org/ontology/Event", "http://dbpedia.org/ontology/CareerStation", "http://dbpedia.org/ontology/Work", "http://dbpedia.org/ontology/TopicalConcept", "http://dbpedia.org/ontology/AnatomicalStructure", "http://dbpedia.org/ontology/Holiday", "http://dbpedia.org/ontology/Food", "http://dbpedia.org/ontology/ChemicalSubstance", "http://dbpedia.org/ontology/Medicine", "http://dbpedia.org/ontology/Name", "http://dbpedia.org/ontology/CelestialBody", "http://dbpedia.org/ontology/SportCompetitionResult", "http://dbpedia.org/ontology/UnitOfWork", "http://dbpedia.org/ontology/GeneLocation", "http://dbpedia.org/ontology/Satellite", "http://dbpedia.org/ontology/PersonFunction", "http://dbpedia.org/ontology/TimePeriod", "http://dbpedia.org/ontology/Language", "http://dbpedia.org/ontology/Sales", "http://dbpedia.org/ontology/Colour", "http://dbpedia.org/ontology/EthnicGroup", "http://dbpedia.org/ontology/Award", "http://dbpedia.org/ontology/Drug", "http://dbpedia.org/ontology/Activity", "http://dbpedia.org/ontology/Currency", "http://dbpedia.org/ontology/SnookerWorldRanking", "http://dbpedia.org/ontology/Swarm", "http://dbpedia.org/ontology/Competition", "http://dbpedia.org/ontology/List"];
    colors = classes.map(function(c, i) {
      var chroma;
      chroma = c === "http://dbpedia.org/ontology/TimePeriod" || c === "http://dbpedia.org/ontology/CareerStation" || c === "http://dbpedia.org/ontology/PersonFunction" || c === "http://www.opengis.net/gml/_Feature" || c === "http://dbpedia.org/ontology/Sales" ? 30 : 55;
      return d3.hcl(15 + i * 30, chroma, 70);
    });
    inset_color = d3.scale.ordinal().domain(classes).range(colors);
    /* depth
    */

    depth_color = d3.scale.linear().domain([0, ontology.levels.length - 1]).range([d3.hcl(200, 0, 90), d3.hcl(360, 30, 30)]).interpolate(d3.interpolateHcl);
    /* triple density
    */

    triple_density_color = d3.scale.linear().domain([
      0, d3.max(map.leaf_regions, function(f) {
        return f.properties.node.stats.triple_density;
      })
    ]).range([d3.hcl(100, 0, 90), d3.hcl(260, 30, 30)]).interpolate(d3.interpolateHcl);
    /* object properties density
    */

    obj_props_density_color = d3.scale.linear().domain([
      0, d3.max(map.leaf_regions, function(f) {
        return f.properties.node.stats.obj_props_density;
      })
    ]).range([d3.hcl(0, 0, 90), d3.hcl(160, 30, 30)]).interpolate(d3.interpolateHcl);
    /* data properties density
    */

    return data_props_density_color = d3.scale.linear().domain([
      0, d3.max(map.leaf_regions, function(f) {
        return f.properties.node.stats.data_props_density;
      })
    ]).range([d3.hcl(50, 0, 90), d3.hcl(210, 30, 30)]).interpolate(d3.interpolateHcl);
  };

  map.mode = function(requested_mode) {
    switch (requested_mode) {
      case 'classes':
        land_layer.selectAll('.leaf_region').attr({
          fill: '#D8D6CC'
        });
        land_layer.selectAll('.high_region').attr({
          stroke: function(n) {
            return inset_color(n.name);
          },
          'stroke-width': '12px'
        });
        break;
      case 'depth':
        land_layer.selectAll('.leaf_region').attr({
          fill: function(r) {
            return depth_color(r.properties.node.depth);
          }
        });
        land_layer.selectAll('.high_region').attr({
          'stroke-width': 0
        });
        break;
      case 'triple_density':
        land_layer.selectAll('.leaf_region').attr({
          fill: function(r) {
            return triple_density_color(r.properties.node.stats.triple_density);
          }
        });
        land_layer.selectAll('.high_region').attr({
          'stroke-width': 0
        });
        break;
      case 'obj_props_density':
        land_layer.selectAll('.leaf_region').attr({
          fill: function(r) {
            return obj_props_density_color(r.properties.node.stats.obj_props_density);
          }
        });
        land_layer.selectAll('.high_region').attr({
          'stroke-width': 0
        });
        break;
      case 'data_props_density':
        land_layer.selectAll('.leaf_region').attr({
          fill: function(r) {
            return data_props_density_color(r.properties.node.stats.data_props_density);
          }
        });
        land_layer.selectAll('.high_region').attr({
          'stroke-width': 0
        });
    }
    return map;
  };

  _draw_leaf_labels = function() {
    var enter_leaf_labels, enter_text, leaf_labels, tspans;
    leaf_labels = leaf_labels_layer.selectAll('.leaf_label').data(ontology.leaves.filter(function(n) {
      return n.depth > 1 && (n.leaf_region != null);
    }));
    enter_leaf_labels = leaf_labels.enter().append('g').attr({
      "class": 'leaf_label',
      transform: function(n) {
        return "translate(" + n.x + "," + n.y + ")";
      }
    });
    enter_text = enter_leaf_labels.append('text').attr({
      "class": 'label',
      transform: 'rotate(60)'
    });
    tspans = enter_text.selectAll('tspan').data(function(n) {
      return n.readable_label;
    });
    return tspans.enter().append('tspan').text(function(t) {
      return t;
    }).attr({
      x: 0,
      dy: '1.2em'
    });
  };

}).call(this);
